<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cooperativa Familiar - Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        .fonte-cupom { font-family: 'Courier Prime', monospace; }
        .cabecalho-tabela { background-color: #ffff00; }
        input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input { color: #000 !important; }
        
        #wrapper-pdf {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 20px;
            z-index: 99999;
        }

        #conteudoPdfExport {
            background: white;
            width: 76mm; 
            padding: 4mm;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-6 font-sans">

    <div class="max-w-[360px] mx-auto bg-white min-h-screen shadow-xl border-x border-gray-200 relative z-10">
        <div class="bg-green-700 p-6 text-white text-center shadow-sm">
            <h1 class="text-xl font-bold uppercase tracking-tight italic opacity-90">Cooperativa</h1>
            <h2 class="text-5xl font-black uppercase tracking-tighter text-yellow-400 -mt-1">CLAF</h2>
            <p class="text-[9px] font-bold opacity-80 mt-2 uppercase tracking-widest">Sistema de Entrega</p>
        </div>

        <form id="meuFormulario" class="p-3 space-y-4">
            <div class="grid grid-cols-2 gap-2 bg-gray-50 p-3 rounded-lg border border-gray-300">
                <div class="col-span-2">
                    <label class="block text-[10px] font-black text-gray-700 mb-0.5 uppercase italic">1. Nome do produtor</label>
                    <input type="text" name="nome" id="inputNome" class="w-full p-2 border border-gray-300 rounded text-sm font-bold text-black" placeholder="O seu nome" required>
                </div>
                <div class="col-span-2">
                    <label class="block text-[10px] font-black text-gray-700 mb-0.5 uppercase italic">2. Data</label>
                    <input type="date" name="data" id="campoData" class="w-full p-2 border border-gray-300 rounded text-sm font-bold text-black" required>
                </div>
            </div>

            <div class="border border-black rounded overflow-hidden bg-white">
                <table class="w-full border-collapse fonte-cupom">
                    <thead>
                        <tr class="cabecalho-tabela">
                            <th class="border-b border-black p-2 text-[10px] font-black uppercase text-left w-2/3">PRODUTO</th>
                            <th class="border-b border-black p-2 text-[10px] font-black uppercase text-center w-1/3">QTD.</th>
                        </tr>
                    </thead>
                    <tbody id="listaProdutos" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>

            <div class="sticky bottom-2 pt-2">
                <button type="submit" id="btnEnviar" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-black text-lg shadow-lg uppercase flex items-center justify-center gap-2">
                    <span>ENVIAR E SALVAR PDF</span>
                </button>
            </div>
        </form>
    </div>

    <div id="wrapper-pdf">
        <div id="conteudoPdfExport" class="fonte-cupom text-black">
            <div style="text-align: center; border-bottom: 2px dashed black; padding-bottom: 10px; margin-bottom: 10px;">
                <h2 style="margin: 0; font-size: 16px; font-weight: bold;">COOPERATIVA CLAF</h2>
                <p style="margin: 0; font-size: 9px; text-transform: uppercase;">Recibo de Pedido</p>
            </div>
            <p style="margin: 3px 0; font-size: 11px;"><strong>PRODUTOR:</strong> <span id="pdfNome"></span></p>
            <p style="margin: 3px 0; font-size: 11px;"><strong>DATA:</strong> <span id="pdfData"></span></p>
            <div style="border-bottom: 1px solid black; margin: 5px 0;"></div>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid black;">
                        <th style="text-align: left; padding: 2px 0; font-size: 10px;">PRODUTO</th>
                        <th style="text-align: right; padding: 2px 0; font-size: 10px;">QTD</th>
                    </tr>
                </thead>
                <tbody id="pdfItens"></tbody>
            </table>
            <div style="margin-top: 10px; border-top: 2px dashed black; padding-top: 10px; text-align: center;">
                <p style="font-size: 8px; margin: 0;">Emitido em: <span id="pdfTimestamp"></span></p>
                <p style="font-size: 11px; font-weight: bold; margin-top: 3px;">Cooperativa CLAF agradece!</p>
            </div>
        </div>
    </div>

    <script>
        const produtos = ["Abacate", "Abacaxi", "Banana caturra", "Banana maçã ou prata", "Laranja baiana lima", "Laranja Comum", "Maçã", "Mamão", "Manga", "Maracujá", "Melancia", "Melão", "Pera", "Pêssego", "Tangerina poncã", "Almeirão", "Acelga", "Agrião", "Alface", "Couve Manteiga", "Escarola", "Espinafre", "Quiabo", "Repolho", "Rúcula", "Abobrinha verde", "Beterraba", "Brócolis", "Cenoura", "Chuchu", "Couve flor", "Milho verde", "Pepino", "Tomate", "Vagem", "Leite Pasteurizado", "Pão Caseiro", "Alho poró", "Cebola", "Cebolinha Verde", "Limão", "Pimentão", "Rabanete", "Salsinha", "Batata doce", "Batata inglesa", "Iogurte"];

        document.getElementById('campoData').value = new Date().toISOString().split('T')[0];
        const tbody = document.getElementById('listaProdutos');

        produtos.forEach((prod, index) => {
            const tr = document.createElement('tr');
            const idPlanilha = prod.normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_');
            tr.innerHTML = `
                <td class="p-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="check_${index}" class="w-4 h-4 rounded border-gray-300">
                        <span class="text-[11px] font-bold text-gray-800 uppercase">${prod}</span>
                    </label>
                </td>
                <td class="p-1">
                    <input type="number" name="${idPlanilha}" min="0" step="any" inputmode="decimal"
                           class="w-full p-1.5 border border-gray-200 rounded text-center text-sm font-black bg-gray-50 text-black"
                           placeholder="0"
                           oninput="document.getElementById('check_${index}').checked = (this.value > 0)">
                </td>
            `;
            tbody.appendChild(tr);
        });

        async function gerarPDF(nome, data, itens) {
            const wrapper = document.getElementById('wrapper-pdf');
            document.getElementById('pdfNome').innerText = nome.toUpperCase();
            document.getElementById('pdfData').innerText = data;
            document.getElementById('pdfTimestamp').innerText = new Date().toLocaleString('pt-PT');
            
            const pdfItensTbody = document.getElementById('pdfItens');
            pdfItensTbody.innerHTML = "";
            itens.forEach(i => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="padding: 4px 0; text-align: left; font-size: 10px;">${i.nome}</td><td style="padding: 4px 0; text-align: right; font-size: 10px;">${i.qtd}</td>`;
                pdfItensTbody.appendChild(tr);
            });

            wrapper.style.display = "flex";
            const alturaEstimada = 100 + (itens.length * 8);
            const opt = {
                margin: 0,
                filename: `Pedido_${nome}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: [80, Math.max(150, alturaEstimada)], orientation: 'portrait' }
            };

            await html2pdf().set(opt).from(document.getElementById('conteudoPdfExport')).save();
            wrapper.style.display = "none";
        }

        document.getElementById('meuFormulario').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnEnviar');
            const params = new URLSearchParams();
            const itensParaPDF = [];
            const inputNome = document.getElementById('inputNome').value;
            const inputData = document.getElementById('campoData').value;

            params.append('nome', inputNome);
            params.append('data', inputData);
            params.append('timestamp', new Date().toLocaleString('pt-PT'));

            const inputsQtd = this.querySelectorAll('input[type="number"]');
            inputsQtd.forEach(input => {
                if (input.value && parseFloat(input.value) > 0) {
                    params.append(input.name, input.value);
                    itensParaPDF.push({ nome: input.name.replace(/_/g, ' '), qtd: input.value });
                }
            });

            if (itensParaPDF.length === 0) { return alert("Preencha pelo menos um produto."); }

            btn.disabled = true;
            btn.innerText = "A ENVIAR...";

            try {
                // Substitua pelo seu link de execução do Apps Script
                const scriptURL = "https://script.google.com/macros/s/AKfycbwj9Pw6zH5ZVKVjqS5eomVO6kHSZUbtNmcVr6DeA8EmISvqmyTNtwuo-MWlwrdFCl17/exec";
                fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: params });
                await gerarPDF(inputNome, inputData, itensParaPDF);
                alert("Pedido enviado com sucesso!");
                location.reload();
            } catch (err) {
                alert("Erro ao enviar.");
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
