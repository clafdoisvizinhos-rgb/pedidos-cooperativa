<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cooperativa Familiar - Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        .fonte-cupom { font-family: 'Courier Prime', monospace; }
        .cabecalho-tabela { background-color: #ffff00; }
        input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input { color: #000 !important; }
        
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: pop 0.3s ease-out forwards; }
        .btn-shadow { box-shadow: 0 4px 0 rgb(21, 128, 61); }
        .btn-shadow:active { box-shadow: none; transform: translateY(2px); }

        #wrapper-pdf {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; display: none; flex-direction: column;
            align-items: center; justify-content: flex-start; padding-top: 20px; z-index: 99999;
        }

        #conteudoPdfExport { background: white; width: 76mm; padding: 4mm; border: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-6 font-sans">

    <div class="max-w-[360px] mx-auto bg-white min-h-screen shadow-xl border-x border-gray-200 relative z-10">
        <!-- Cabeçalho Principal -->
        <div class="bg-green-700 p-6 text-white text-center shadow-sm">
            <h1 class="text-xl font-bold uppercase tracking-tight italic opacity-90">Cooperativa</h1>
            <h2 class="text-5xl font-black uppercase tracking-tighter text-yellow-400 -mt-1">CLAF</h2>
            <div class="mt-2 h-1 w-16 bg-white mx-auto opacity-50"></div>
            <p class="text-[9px] font-bold opacity-80 mt-2 uppercase tracking-widest">Sistema de Entrega</p>
        </div>

        <form id="meuFormulario" class="p-3 space-y-4">
            <div class="grid grid-cols-2 gap-2 bg-gray-50 p-3 rounded-lg border border-gray-300">
                <div class="col-span-2">
                    <label class="block text-[10px] font-black text-gray-700 mb-0.5 uppercase italic">1. Nome do produtor</label>
                    <input type="text" name="nome" id="inputNome" class="w-full p-2 border border-gray-300 rounded focus:border-green-600 outline-none text-sm font-bold text-black" placeholder="O seu nome" required>
                </div>
                <div class="col-span-2">
                    <label class="block text-[10px] font-black text-gray-700 mb-0.5 uppercase italic">2. Data</label>
                    <input type="date" name="data" id="campoData" class="w-full p-2 border border-gray-300 rounded focus:border-green-600 outline-none text-sm font-bold text-black" required>
                </div>
            </div>

            <div class="border border-black rounded overflow-hidden bg-white">
                <table class="w-full border-collapse fonte-cupom">
                    <thead>
                        <tr class="cabecalho-tabela">
                            <th class="border-b border-black p-2 text-[10px] font-black uppercase text-left w-2/3">PRODUTO</th>
                            <th class="border-b border-black p-2 text-[10px] font-black uppercase text-center w-1/3">QTD.</th>
                        </tr>
                    </thead>
                    <tbody id="listaProdutos" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>

            <div class="sticky bottom-2 pt-2">
                <button type="submit" id="btnEnviar" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-black text-lg btn-shadow transition-all transform uppercase flex items-center justify-center gap-2">
                    <span>ENVIAR E SALVAR PDF</span>
                    <span class="text-xl">➔</span>
                </button>
            </div>
        </form>
    </div>

    <!-- ÁREA DO PDF -->
    <div id="wrapper-pdf">
        <div class="mb-4 text-green-700 font-black text-sm animate-pulse">A PREPARAR CUPOM...</div>
        <div id="conteudoPdfExport" class="fonte-cupom">
            <div style="text-align: center; border-bottom: 2px dashed black; padding-bottom: 10px; margin-bottom: 10px;">
                <h2 style="margin: 0; font-size: 16px; color: black; font-weight: bold;">COOPERATIVA CLAF</h2>
                <p style="margin: 0; font-size: 9px; text-transform: uppercase; color: black;">Recibo de Pedido</p>
            </div>
            
            <p style="margin: 3px 0; color: black; font-size: 11px;"><strong>PRODUTOR:</strong> <span id="pdfNome"></span></p>
            <p style="margin: 3px 0; color: black; font-size: 11px;"><strong>DATA:</strong> <span id="pdfData"></span></p>
            <div style="border-bottom: 1px solid black; margin: 5px 0;"></div>
            
            <table style="width: 100%; border-collapse: collapse; color: black;">
                <thead>
                    <tr style="border-bottom: 1px solid black;">
                        <th style="text-align: left; padding: 2px 0; font-size: 10px;">PRODUTO</th>
                        <th style="text-align: right; padding: 2px 0; font-size: 10px;">QTD</th>
                    </tr>
                </thead>
                <tbody id="pdfItens"></tbody>
            </table>
            
            <div style="margin-top: 10px; border-top: 2px dashed black; padding-top: 10px; text-align: center;">
                <p style="font-size: 8px; margin: 0; color: black;">Emitido em: <span id="pdfTimestamp"></span></p>
                <p style="font-size: 11px; font-weight: bold; margin-top: 3px; color: black;">Cooperativa CLAF agradece!</p>
                <div style="height: 25px;"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Sucesso -->
    <div id="modalSucesso" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-2xl text-center max-w-[280px] w-full border-4 border-green-500 shadow-2xl animate-pop">
            <div class="w-14 h-14 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3 text-3xl font-bold">✓</div>
            <h2 class="text-xl font-black text-green-700 uppercase mb-1">Pedido Enviado!</h2>
            <p class="text-gray-600 font-bold mb-4 text-[10px] italic text-center">O cupom foi gerado e os dados salvos.</p>
            <button onclick="novoPedido()" class="w-full bg-green-600 text-white py-3 rounded-lg font-black uppercase text-xs">NOVO PEDIDO</button>
        </div>
    </div>

    <script>
        const produtos = ["Abacate", "Abacaxi", "Banana caturra", "Banana maçã ou prata", "Laranja baiana lima", "Laranja Comum", "Maçã", "Mamão", "Manga", "Maracujá", "Melancia", "Melão", "Pera", "Pêssego", "Tangerina poncã", "Almeirão", "Acelga", "Agrião", "Alface", "Couve Manteiga", "Escarola", "Espinafre", "Quiabo", "Repolho", "Rúcula", "Abobrinha verde", "Beterraba", "Brócolis", "Cenoura", "Chuchu", "Couve flor", "Milho verde", "Pepino", "Tomate", "Vagem", "Leite Pasteurizado", "Pão Caseiro", "Alho poró", "Cebola", "Cebolinha Verde", "Limão", "Pimentão", "Rabanete", "Salsinha", "Batata doce", "Batata inglesa", "Iogurte"];

        document.getElementById('campoData').value = new Date().toISOString().split('T')[0];
        const tbody = document.getElementById('listaProdutos');

        produtos.forEach((prod, index) => {
            const tr = document.createElement('tr');
            tr.className = "item-row border-b border-gray-100";
            const idPlanilha = prod.normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_');
            tr.innerHTML = `
                <td class="p-2">
                    <label class="flex items-center gap-2 cursor-pointer select-none">
                        <input type="checkbox" id="check_${index}" class="w-4 h-4 rounded border-gray-300 text-green-600">
                        <span class="text-[11px] font-bold text-gray-800 uppercase tracking-tighter">${prod}</span>
                    </label>
                </td>
                <td class="p-1">
                    <input type="number" name="${idPlanilha}" min="0" step="any" inputmode="decimal"
                           class="w-full p-1.5 border border-gray-200 rounded text-center text-sm font-black bg-gray-50 outline-none text-black"
                           placeholder="0"
                           oninput="document.getElementById('check_${index}').checked = (this.value > 0)">
                </td>
            `;
            tbody.appendChild(tr);
        });

        async function gerarPDF(nome, data, itens) {
            const wrapper = document.getElementById('wrapper-pdf');
            const element = document.getElementById('conteudoPdfExport');
            const pdfItensTbody = document.getElementById('pdfItens');
            
            document.getElementById('pdfNome').innerText = nome.toUpperCase();
            document.getElementById('pdfData').innerText = data.split('-').reverse().join('/');
            document.getElementById('pdfTimestamp').innerText = new Date().toLocaleString('pt-BR');
            pdfItensTbody.innerHTML = "";
            
            itens.forEach(i => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = "1px solid #eee";
                tr.innerHTML = `<td style="padding: 4px 0; text-align: left; font-weight: bold; color: black; font-size: 10px;">${i.nome}</td><td style="padding: 4px 0; text-align: right; font-weight: bold; color: black; font-size: 10px;">${i.qtd}</td>`;
                pdfItensTbody.appendChild(tr);
            });

            wrapper.style.display = "flex";
            window.scrollTo(0,0);
            await new Promise(r => setTimeout(r, 800));

            const opt = {
                margin: 0,
                filename: `Pedido_CLAF_${nome.replace(/\s+/g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, backgroundColor: "#ffffff" },
                jsPDF: { unit: 'mm', format: [80, Math.max(160, 100 + (itens.length * 9))], orientation: 'portrait' }
            };

            try { await html2pdf().set(opt).from(element).save(); } 
            finally { wrapper.style.display = "none"; }
        }

        document.getElementById('meuFormulario').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnEnviar');
            const params = new URLSearchParams();
            const itensParaPDF = [];
            const inputNome = document.getElementById('inputNome').value;
            const inputData = document.getElementById('campoData').value;

            params.append('nome', inputNome);
            params.append('data', inputData);
            params.append('timestamp', new Date().toLocaleString('pt-BR'));

            this.querySelectorAll('input[type="number"]').forEach(input => {
                let valor = input.value.replace(',', '.');
                params.append(input.name, valor || "");
                if (valor && parseFloat(valor) > 0) {
                    itensParaPDF.push({ nome: input.name.replace(/_/g, ' '), qtd: valor });
                }
            });

            if (itensParaPDF.length === 0) {
                alert("Insira a quantidade em pelo menos um produto.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<span class="animate-pulse">A ENVIAR...</span>`;

            try {
                // VERIFIQUE SE ESTE LINK É O DA SUA ÚLTIMA IMPLANTAÇÃO
                const scriptURL = "/**
 * SISTEMA COOPERATIVA FAMILIAR - VERSÃO FINAL SCRIPT DIRETO
 * - Ordem de colunas fixa (conforme formulário)
 * - Registro de histórico em RECEBIMENTO_DE_DADOS
 * - Soma automática em ORGANIZAÇÃO_DE_DADOS
 */

function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ABA_RECEBIMENTO = "RECEBIMENTO_DE_DADOS";
  const ABA_ORGANIZACAO = "ORGANIZAÇÃO_DE_DADOS";
  
  // LISTA MESTRE NA ORDEM DO FORMULÁRIO (Para garantir a ordem das colunas)
  const ORDEM_PRODUTOS = [
    "ABACATE", "ABACAXI", "BANANA CATURRA", "BANANA MACA OU PRATA", "LARANJA BAIANA LIMA", 
    "LARANJA COMUM", "MACA", "MAMAO", "MANGA", "MARACUJA", "MELANCIA", "MELAO", "PERA", 
    "PÊSSEGO", "TANGERINA PONCÃ", "ALMEIRAO", "ACELGA", "AGRIAO", 
    "ALFACE", "COUVE MANTEIGA", "ESCAROLA", "ESPINAFRE", "QUIABO", "REPOLHO", 
    "RUCULA", "ABOBRINHA VERDE", "BETERRABA", "BROCOLIS", "CENOURA", "CHUCHU", 
    "COUVE FLOR", "MILHO VERDE", "PEPINO", "TOMATE", "VAGEM", "LEITE PASTEURIZADO", 
    "PAO CASEIRO", "ALHO PORO", "CEBOLA", "CEBOLINHA VERDE", "LIMAO", "PIMENTAO", 
    "RABANETE", "SALSINHA", "BATATA DOCE", "BATATA INGLESA", "IOGURTE"
  ];

  let sheetRecebimento = ss.getSheetByName(ABA_RECEBIMENTO) || ss.insertSheet(ABA_RECEBIMENTO);
  let sheetOrganizacao = ss.getSheetByName(ABA_ORGANIZACAO) || ss.insertSheet(ABA_ORGANIZACAO);

  const data = e.parameter;
  // Nome sempre em MAIÚSCULO
  let nomeProdutor = data.nome ? data.nome.toString().trim().toUpperCase() : "ANONIMO";
  
  const lock = LockService.getScriptLock();
  
  try {
    // Aguarda até 30 segundos para obter acesso exclusivo (evita erros em envios simultâneos)
    lock.waitLock(30000);

    // --- PARTE 1: HISTÓRICO (RECEBIMENTO_DE_DADOS) ---
    let headersHist = sheetRecebimento.getRange(1, 1, 1, Math.max(sheetRecebimento.getLastColumn(), 1)).getValues()[0];
    
    // Se a planilha estiver sem cabeçalhos ou fora de ordem, reconstrói
    if (headersHist.length < 5 || headersHist[0] === "" || headersHist[3] !== ORDEM_PRODUTOS[0]) {
      headersHist = ["TIMESTAMP", "NOME", "DATA"].concat(ORDEM_PRODUTOS);
      sheetRecebimento.clearContents();
      sheetRecebimento.getRange(1, 1, 1, headersHist.length)
        .setValues([headersHist])
        .setFontWeight("bold")
        .setBackground("#F3F4F6");
      sheetRecebimento.setFrozenRows(1);
    }

    // Prepara a linha para o histórico
    const rowHist = headersHist.map(h => {
      let hUpper = h.toString().toUpperCase().trim();
      if (hUpper === "TIMESTAMP") return new Date().toLocaleString('pt-BR');
      if (hUpper === "NOME") return nomeProdutor;
      if (hUpper === "DATA") return data.data || "";
      
      // Converte o nome da coluna para o formato que o HTML envia (sem acentos e com _)
      let keyBusca = hUpper.replace(/\s/g, "_")
                           .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                           .replace(/[^A-Z0-9_]/gi, "");
      
      let val = data[keyBusca];
      return (val && val !== "") ? parseFloat(val.toString().replace(',', '.')) || 0 : "";
    });
    sheetRecebimento.appendRow(rowHist);


    // --- PARTE 2: CONSOLIDAÇÃO (ORGANIZAÇÃO_DE_DADOS) ---
    let headersOrg = sheetOrganizacao.getRange(1, 1, 1, Math.max(sheetOrganizacao.getLastColumn(), 1)).getValues()[0];
    if (!headersOrg[0]) {
      sheetOrganizacao.getRange(1, 1).setValue("PRODUTOS").setFontWeight("bold");
      headersOrg = ["PRODUTOS"];
    }

    // Encontra ou cria a coluna para o produtor
    let colProdutor = headersOrg.indexOf(nomeProdutor) + 1;
    if (colProdutor === 0) {
      colProdutor = sheetOrganizacao.getLastColumn() + 1;
      sheetOrganizacao.getRange(1, colProdutor).setValue(nomeProdutor).setFontWeight("bold").setBackground("#DCFCE7");
    }

    // Soma as quantidades enviadas
    Object.keys(data).forEach(key => {
      if (!["nome", "data", "timestamp"].includes(key.toLowerCase())) {
        let itemNome = key.replace(/_/g, " ").toUpperCase();
        let qtdNova = parseFloat(data[key].toString().replace(',', '.')) || 0;

        if (qtdNova > 0) {
          let itensExistentes = sheetOrganizacao.getRange(1, 1, Math.max(sheetOrganizacao.getLastRow(), 1), 1).getValues().map(r => r[0].toString().toUpperCase());
          let linhaItem = itensExistentes.indexOf(itemNome) + 1;

          if (linhaItem === 0) {
            linhaItem = sheetOrganizacao.getLastRow() + 1;
            sheetOrganizacao.getRange(linhaItem, 1).setValue(itemNome).setFontWeight("bold");
          }

          let celula = sheetOrganizacao.getRange(linhaItem, colProdutor);
          let valorAtual = parseFloat(celula.getValue()) || 0;
          celula.setValue(valorAtual + qtdNova);
        }
      }
    });

    lock.releaseLock();
    return ContentService.createTextOutput(JSON.stringify({"result": "success"})).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    if (lock.hasLock()) lock.releaseLock();
    return ContentService.createTextOutput(JSON.stringify({"result": "error", "message": err.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}";
                
                fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params.toString()
                });

                await gerarPDF(inputNome, inputData, itensParaPDF);
                document.getElementById('modalSucesso').classList.replace('hidden', 'flex');
            } catch (err) {
                alert("Erro ao enviar. Verifique sua internet.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<span>ENVIAR E SALVAR PDF</span><span class="text-xl">➔</span>`;
            }
        });

        function novoPedido() { location.reload(); }
    </script>
</body>
</html>
