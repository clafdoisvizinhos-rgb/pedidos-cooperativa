/**
 * SISTEMA COOPERATIVA CLAF - SOMA POR PRODUTOR
 */

function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheetHistorico = ss.getSheets()[0]; 
  const NOME_ABA_CONSOLIDADO = "ORGANIZAÇÃO_DE_DADOS";
  let sheetConsolidado = ss.getSheetByName(NOME_ABA_CONSOLIDADO) || ss.insertSheet(NOME_ABA_CONSOLIDADO);

  const data = e.parameter;
  const nomeProdutor = data.nome ? data.nome.trim().toUpperCase() : "ANÔNIMO";
  const lock = LockService.getScriptLock();
  
  try {
    lock.waitLock(30000);

    // 1. REGISTRO NO HISTÓRICO (Aba 1)
    let headersHist = sheetHistorico.getRange(1, 1, 1, Math.max(sheetHistorico.getLastColumn(), 1)).getValues()[0];
    const rowHist = headersHist.map(h => {
      if (h === "TIMESTAMP") return new Date().toLocaleString('pt-BR');
      if (h === "NOME") return nomeProdutor;
      if (h === "DATA") return data.data || "";
      let val = data[Object.keys(data).find(k => k.toUpperCase() === h.toUpperCase())];
      return val ? parseFloat(val.toString().replace(',', '.')) : "";
    });
    sheetHistorico.appendRow(rowHist);

    // 2. CONSOLIDAÇÃO E SOMA (Aba ORGANIZAÇÃO_DE_DADOS)
    const ultimaColCons = Math.max(sheetConsolidado.getLastColumn(), 1);
    let headersCons = sheetConsolidado.getRange(1, 1, 1, ultimaColCons).getValues()[0].map(h => h.toString().toUpperCase());
    
    // Localiza a coluna do produtor
    let colProdutor = headersCons.indexOf(nomeProdutor) + 1;
    if (colProdutor === 0) {
      colProdutor = ultimaColCons + 1;
      sheetConsolidado.getRange(1, colProdutor).setValue(nomeProdutor).setFontWeight("bold");
    }

    // Processa cada campo enviado
    Object.keys(data).forEach(key => {
      // Ignora campos de controle
      if (!["nome", "data", "timestamp"].includes(key.toLowerCase())) {
        let valorTexto = data[key];
        let qtdNova = parseFloat(valorTexto.toString().replace(',', '.')) || 0;

        if (qtdNova > 0) {
          // Nome do produto como vem do HTML (ex: Banana_caturra -> BANANA CATURRA)
          let nomeProdFormatado = key.replace(/_/g, " ").toUpperCase();
          
          let ultimaLinhaCons = Math.max(sheetConsolidado.getLastRow(), 1);
          let listaProds = sheetConsolidado.getRange(1, 1, ultimaLinhaCons, 1).getValues().map(r => r[0].toString().toUpperCase());
          
          let linhaProd = listaProds.indexOf(nomeProdFormatado) + 1;

          if (linhaProd === 0) {
            linhaProd = ultimaLinhaCons + 1;
            sheetConsolidado.getRange(linhaProd, 1).setValue(nomeProdFormatado).setFontWeight("bold");
          }

          // SOMA O VALOR
          let celula = sheetConsolidado.getRange(linhaProd, colProdutor);
          let valorAtual = parseFloat(celula.getValue()) || 0;
          celula.setValue(valorAtual + qtdNova);
        }
      }
    });

    lock.releaseLock();
    return ContentService.createTextOutput("Sucesso");

  } catch (err) {
    if (lock.hasLock()) lock.releaseLock();
    return ContentService.createTextOutput("Erro: " + err.message);
  }
}
